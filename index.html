<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Reseller System - Super Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #21808d;
            --primary-dark: #1d7480;
            --bg: #fcfcf9;
            --card-bg: #fffffe;
            --text: #13343b;
            --text-secondary: #626c71;
            --border: rgba(94, 82, 64, 0.12);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        [data-theme="dark"] {
            --primary: #32b8c6;
            --primary-dark: #2da6b2;
            --bg: #1f2121;
            --card-bg: #262828;
            --text: #f5f5f5;
            --text-secondary: #a7a9a9;
            --border: rgba(119, 124, 124, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: var(--primary);
            opacity: 0.1;
            border-radius: 0 15px 0 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-trend {
            font-size: 13px;
            color: var(--success);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
            transition: 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(33, 128, 141, 0.1);
        }

        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(33, 128, 141, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: rgba(98, 108, 113, 0.15);
            color: var(--text);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg);
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.show {
            display: block;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 400px;
            background: var(--bg);
            color: var(--text);
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: var(--bg);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1><i class="fas fa-rocket"></i> API Reseller System</h1>
            <p>Super Admin Control Panel - Advanced Analytics & Management</p>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-moon"></i> Toggle Theme
        </button>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-users"></i> Total Users</h3>
                <div class="value" id="totalUsers">0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> +12% this month</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-handshake"></i> Active Resellers</h3>
                <div class="value" id="totalResellers">0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> +8% this month</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-key"></i> APIs Generated</h3>
                <div class="value" id="totalAPIs">0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> +15% this month</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-rupee-sign"></i> Revenue</h3>
                <div class="value" id="totalRevenue">₹0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> +25% this month</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="tab" onclick="switchTab('analytics')"><i class="fas fa-chart-bar"></i> Analytics</button>
            <button class="tab" onclick="switchTab('generate')"><i class="fas fa-key"></i> Generate API</button>
            <button class="tab" onclick="switchTab('users')"><i class="fas fa-users"></i> Users</button>
            <button class="tab" onclick="switchTab('resellers')"><i class="fas fa-handshake"></i> Resellers</button>
            <button class="tab" onclick="switchTab('billing')"><i class="fas fa-file-invoice-dollar"></i> Billing</button>
            <button class="tab" onclick="switchTab('apis')"><i class="fas fa-cog"></i> API Management</button>
            <button class="tab" onclick="switchTab('settings')"><i class="fas fa-sliders-h"></i> Settings</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2><i class="fas fa-tachometer-alt"></i> System Overview</h2>
                <div class="chart-container">
                    <i class="fas fa-chart-line" style="font-size: 48px;"></i>
                    <p style="margin-left: 20px;">Real-time monitoring active<br><small>Chart visualization coming soon</small></p>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activityLog">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-secondary);">No recent activity</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Usage Analytics</h2>
                <div class="chart-container">
                    <div style="text-align: center;">
                        <i class="fas fa-analytics" style="font-size: 48px;"></i>
                        <p style="margin-top: 15px;">Hourly / Daily / Monthly Charts<br><small>Advanced analytics coming soon</small></p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-exclamation-triangle"></i> Error Tracking</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Monitor 401, 429, and 500 errors</p>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card">
                        <h3>401 Errors</h3>
                        <div class="value" style="font-size: 28px;">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>429 Errors</h3>
                        <div class="value" style="font-size: 28px;">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>500 Errors</h3>
                        <div class="value" style="font-size: 28px;">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="generate" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-key"></i> Generate New API Key</h2>
                <form id="generateAPIForm">
                    <div class="form-group">
                        <label for="userTelegramId">User Telegram ID</label>
                        <input type="text" class="form-control" id="userTelegramId" placeholder="Enter Telegram ID" required>
                    </div>
                    <div class="form-group">
                        <label for="userName">User Name</label>
                        <input type="text" class="form-control" id="userName" placeholder="Enter user name" required>
                    </div>
                    <div class="form-group">
                        <label for="apiType">API Type</label>
                        <select class="form-control" id="apiType" required>
                            <option value="perplexity">Perplexity AI</option>
                            <option value="openai">OpenAI GPT</option>
                            <option value="claude">Claude AI</option>
                            <option value="custom">Custom API</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rateLimit">Rate Limit (requests/month)</label>
                        <input type="number" class="form-control" id="rateLimit" value="1000" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDays">Expiry (days)</label>
                        <input type="number" class="form-control" id="expiryDays" value="30" required>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Generate API Key</button>
                </form>
            </div>
        </div>

        <div id="users" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> User Management</h2>
                <input type="text" class="search-box" placeholder="Search users..." onkeyup="filterTable('usersTable', this.value)">
                <button class="btn btn-secondary" onclick="exportCSV('users')"><i class="fas fa-download"></i> Export CSV</button>
                <div class="table-wrapper" style="margin-top: 15px;">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Telegram ID</th>
                                <th>Name</th>
                                <th>API Key</th>
                                <th>Status</th>
                                <th>Expiry</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-secondary);">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="resellers" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-handshake"></i> Reseller Management</h2>
                <button class="btn btn-primary" style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Add New Reseller</button>
                <div class="table-wrapper">
                    <table id="resellersTable">
                        <thead>
                            <tr>
                                <th>Reseller ID</th>
                                <th>Name</th>
                                <th>Commission (%)</th>
                                <th>Earnings</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-secondary);">Loading resellers...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="billing" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-file-invoice-dollar"></i> Billing & Invoices</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 25px;">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" style="font-size: 28px;">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Payments</h3>
                        <div class="value" style="font-size: 28px;">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Reseller Payouts</h3>
                        <div class="value" style="font-size: 28px;">₹0</div>
                    </div>
                </div>
                <button class="btn btn-success"><i class="fas fa-file-pdf"></i> Generate GST Invoice</button>
                <button class="btn btn-primary"><i class="fas fa-wallet"></i> Process Payouts</button>
            </div>

            <div class="card">
                <h2><i class="fas fa-tags"></i> Subscription Plans</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Basic Plan</h3>
                        <div class="value" style="font-size: 24px;">₹499/mo</div>
                        <p style="margin-top: 10px; color: var(--text-secondary);">1,000 requests</p>
                    </div>
                    <div class="stat-card">
                        <h3>Pro Plan</h3>
                        <div class="value" style="font-size: 24px;">₹999/mo</div>
                        <p style="margin-top: 10px; color: var(--text-secondary);">5,000 requests</p>
                    </div>
                    <div class="stat-card">
                        <h3>Unlimited</h3>
                        <div class="value" style="font-size: 24px;">₹2499/mo</div>
                        <p style="margin-top: 10px; color: var(--text-secondary);">Unlimited requests</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="apis" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-cog"></i> API Key Management</h2>
                <input type="text" class="search-box" placeholder="Search APIs..." onkeyup="filterTable('apisTable', this.value)">
                <button class="btn btn-danger" style="margin-bottom: 15px;"><i class="fas fa-ban"></i> Bulk Revoke</button>
                <div class="table-wrapper">
                    <table id="apisTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onclick="selectAll(this)"></th>
                                <th>API Key</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Usage</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-secondary);">Loading APIs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> System Settings</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="masterAPIKey">Master Perplexity API Key</label>
                        <input type="password" class="form-control" id="masterAPIKey" placeholder="Enter your API key">
                    </div>
                    <div class="form-group">
                        <label for="telegramToken">Telegram Bot Token</label>
                        <input type="password" class="form-control" id="telegramToken" placeholder="Enter bot token">
                    </div>
                    <div class="form-group">
                        <label for="webhookURL">Webhook URL (Render Link)</label>
                        <input type="url" class="form-control" id="webhookURL" placeholder="https://your-app.onrender.com">
                    </div>
                    <div class="form-group">
                        <label for="apiPrice">API Price per Month (₹)</label>
                        <input type="number" class="form-control" id="apiPrice" value="499">
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Settings</button>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-database"></i> System Maintenance</h2>
                <button class="btn btn-primary"><i class="fas fa-download"></i> Backup Data</button>
                <button class="btn btn-secondary"><i class="fas fa-upload"></i> Restore Backup</button>
                <button class="btn btn-secondary"><i class="fas fa-broom"></i> Clear Logs</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            showToast(`Theme switched to ${newTheme} mode`);
        }

        // Load saved theme
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            loadStats();
            loadUsers();
            loadResellers();
            loadAPIs();
            loadActivities();
        });

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Toast Notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // Load Stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('totalUsers').textContent = stats.users;
                document.getElementById('totalResellers').textContent = stats.resellers;
                document.getElementById('totalAPIs').textContent = stats.apis;
                document.getElementById('totalRevenue').textContent = '₹' + stats.revenue.toLocaleString('en-IN');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = Object.entries(users).map(([id, user]) => `
                    <tr>
                        <td>${id}</td>
                        <td>${user.name}</td>
                        <td><code>${user.api_key?.substring(0, 20)}...</code></td>
                        <td><span class="badge badge-success">${user.status}</span></td>
                        <td>${new Date(user.expiry).toLocaleDateString()}</td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary" style="padding: 6px 12px;">View</button>
                            <button class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load Resellers
        async function loadResellers() {
            try {
                const response = await fetch('/api/resellers');
                const resellers = await response.json();
                const tbody = document.querySelector('#resellersTable tbody');
                tbody.innerHTML = Object.entries(resellers).map(([id, reseller]) => `
                    <tr>
                        <td>${reseller.id}</td>
                        <td>${reseller.name}</td>
                        <td>${reseller.commission}%</td>
                        <td>₹${reseller.earnings?.toLocaleString('en-IN') || 0}</td>
                        <td><span class="badge badge-success">${reseller.status}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary" style="padding: 6px 12px;">Edit</button>
                            <button class="btn btn-danger" style="padding: 6px 12px;">Delete</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center;">No resellers found</td></tr>';
            } catch (error) {
                console.error('Error loading resellers:', error);
            }
        }

        // Load APIs
        async function loadAPIs() {
            try {
                const response = await fetch('/api/apis');
                const apis = await response.json();
                const tbody = document.querySelector('#apisTable tbody');
                tbody.innerHTML = Object.entries(apis).map(([key, api]) => `
                    <tr>
                        <td><input type="checkbox"></td>
                        <td><code>${key.substring(0, 20)}...</code></td>
                        <td>${api.username}</td>
                        <td>${api.type}</td>
                        <td>${api.requests}/${api.limit}</td>
                        <td><span class="badge badge-${api.status === 'active' ? 'success' : 'danger'}">${api.status}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-danger" style="padding: 6px 12px;">Revoke</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="7" style="text-align: center;">No APIs found</td></tr>';
            } catch (error) {
                console.error('Error loading APIs:', error);
            }
        }

        // Load Activities
        async function loadActivities() {
            try {
                const response = await fetch('/api/activities');
                const activities = await response.json();
                const tbody = document.getElementById('activityLog');
                tbody.innerHTML = activities.slice(0, 10).map(act => `
                    <tr>
                        <td>${new Date(act.time).toLocaleTimeString()}</td>
                        <td>${act.user}</td>
                        <td>${act.action}</td>
                        <td><span class="badge badge-${act.status === 'success' ? 'success' : 'warning'}">${act.status}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align: center;">No activity yet</td></tr>';
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // Generate API Form
        document.getElementById('generateAPIForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                telegramId: document.getElementById('userTelegramId').value,
                userName: document.getElementById('userName').value,
                apiType: document.getElementById('apiType').value,
                rateLimit: document.getElementById('rateLimit').value,
                expiryDays: document.getElementById('expiryDays').value
            };

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('✅ API Key generated successfully!');
                    loadStats();
                    loadUsers();
                    loadAPIs();
                    e.target.reset();
                }
            } catch (error) {
                showToast('❌ Error generating API key');
                console.error(error);
            }
        });

        // Settings Form
        document.getElementById('settingsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                master_api: document.getElementById('masterAPIKey').value,
                bot_token: document.getElementById('telegramToken').value,
                webhook_url: document.getElementById('webhookURL').value,
                api_price: parseInt(document.getElementById('apiPrice').value)
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                if (response.ok) {
                    showToast('✅ Settings saved successfully!');
                }
            } catch (error) {
                showToast('❌ Error saving settings');
                console.error(error);
            }
        });

        // Filter Table
        function filterTable(tableId, query) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // Export CSV
        function exportCSV(type) {
            showToast(`Exporting ${type} data as CSV...`);
            // CSV export logic here
        }

        // Select All Checkboxes
        function selectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#apisTable tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            loadStats();
            loadActivities();
        }, 30000);
    </script>
</body>
</html>